<!DOCTYPE html>
<html lang="en">
<head>
    <!-- ... (पहले जैसा CSS) ... -->
</head>
<body>
    <!-- ... (पहले जैसा HTML) ... -->

    <script>
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyBO7dxMxJwcSEceULVYH0K6n8d59wALw7U",
            authDomain: "dragon-tiger-game-8b5b0.firebaseapp.com",
            projectId: "dragon-tiger-game-8b5b0",
            storageBucket: "dragon-tiger-game-8b5b0.firebasestorage.app",
            messagingSenderId: "885603497015",
            appId: "1:885603497015:web:afc57007437a3166ecfbb2"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // Game state
        let userPoints = 1000;
        let currentUser = null;
        let timerInterval = null;
        let timeLeft = 20;
        let currentBet = null;
        const timerEl = document.getElementById("timer");
        const betAmountInput = document.getElementById("betAmount");
        const pointsEl = document.getElementById("points");

        // Check auth state
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                document.getElementById("userEmail").innerText = user.email;
                loadUserData(user.uid);
                startTimer();
            } else {
                window.location.href = "index.html";
            }
        });

        // Load user data from Firestore
        function loadUserData(uid) {
            db.collection("users").doc(uid).get()
                .then(doc => {
                    if (doc.exists) {
                        const userData = doc.data();
                        userPoints = userData.points || 0;
                        pointsEl.innerText = userPoints;
                        betAmountInput.max = userPoints;
                        
                        if (userData.isBlocked) {
                            document.getElementById("result").innerText = "Your account is blocked!";
                            document.getElementById("result").className = "lose";
                            document.getElementById("dragonBtn").disabled = true;
                            document.getElementById("tigerBtn").disabled = true;
                            document.getElementById("tieBtn").disabled = true;
                        }
                    }
                })
                .catch(error => {
                    console.error("Error loading user data:", error);
                });
        }

        // Create background particles
        function createParticles() {
            // ... (पहले जैसा) ...
        }
        
        // Initialize particles
        createParticles();
        
        // Start the game timer
        function startTimer() {
            clearInterval(timerInterval);
            timeLeft = 20;
            timerEl.innerText = timeLeft;
            timerEl.classList.remove("warning");
            
            const dragonBtn = document.getElementById("dragonBtn");
            const tigerBtn = document.getElementById("tigerBtn");
            const tieBtn = document.getElementById("tieBtn");
            const betInput = document.getElementById("betAmount");
            
            dragonBtn.disabled = false;
            tigerBtn.disabled = false;
            tieBtn.disabled = false;
            betInput.disabled = false;
            
            currentBet = null;
            document.getElementById("result").innerText = "Place your bet!";
            document.getElementById("result").className = "";
            
            timerInterval = setInterval(() => {
                timeLeft--;
                timerEl.innerText = timeLeft;
                
                if (timeLeft <= 5) {
                    timerEl.classList.add("warning");
                }
                
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    dragonBtn.disabled = true;
                    tigerBtn.disabled = true;
                    tieBtn.disabled = true;
                    betInput.disabled = true;
                    
                    if (currentBet) {
                        processBetResult();
                    } else {
                        document.getElementById("result").innerText = "No bet placed! Wait for the next round.";
                        document.getElementById("result").className = "lose";
                        startNewRound();
                    }
                }
            }, 1000);
        }

        // Place a bet
        function placeBet(choice) {
            const resultEl = document.getElementById("result");
            const betAmount = parseInt(betAmountInput.value);
            
            if (isNaN(betAmount) || betAmount < 1) {
                resultEl.innerText = "Please enter a valid bet amount (minimum 1 point)";
                resultEl.className = "lose";
                return;
            }
            
            if (betAmount > userPoints) {
                resultEl.innerText = `Not enough points! Maximum bet is ${userPoints} points`;
                resultEl.className = "lose";
                return;
            }
            
            currentBet = {
                choice: choice,
                amount: betAmount
            };
            
            resultEl.innerText = `Bet placed: ${betAmount} points on ${choice.charAt(0).toUpperCase() + choice.slice(1)}! Waiting for timer...`;
            resultEl.className = "";
            
            document.getElementById("dragonBtn").disabled = true;
            document.getElementById("tigerBtn").disabled = true;
            document.getElementById("tieBtn").disabled = true;
            betAmountInput.disabled = true;
        }

        // Process the bet result
        function processBetResult() {
            const resultEl = document.getElementById("result");
            const dragonCardEl = document.getElementById("dragonCard");
            const tigerCardEl = document.getElementById("tigerCard");
            
            const dragonCard = Math.floor(Math.random() * 13) + 1;
            const tigerCard = Math.floor(Math.random() * 13) + 1;
            
            dragonCardEl.classList.add("flipped", "dealing");
            tigerCardEl.classList.add("flipped", "dealing");
            
            setTimeout(() => {
                document.getElementById("dragonValue").innerText = dragonCard;
                document.getElementById("tigerValue").innerText = tigerCard;
                
                let win = false;
                let winAmount = 0;
                let transactionType = "Bet Loss";
                let transactionDescription = `Lost bet on ${currentBet.choice.charAt(0).toUpperCase() + currentBet.choice.slice(1)} (Dragon: ${dragonCard}, Tiger: ${tigerCard})`;
                
                if (currentBet.choice === 'dragon' && dragonCard > tigerCard) {
                    win = true;
                    winAmount = currentBet.amount * 2;
                    transactionType = "Bet Win";
                    transactionDescription = `Won bet on Dragon (Dragon: ${dragonCard}, Tiger: ${tigerCard})`;
                } else if (currentBet.choice === 'tiger' && tigerCard > dragonCard) {
                    win = true;
                    winAmount = currentBet.amount * 2;
                    transactionType = "Bet Win";
                    transactionDescription = `Won bet on Tiger (Dragon: ${dragonCard}, Tiger: ${tigerCard})`;
                } else if (currentBet.choice === 'tie' && dragonCard === tigerCard) {
                    win = true;
                    winAmount = currentBet.amount * 8;
                    transactionType = "Bet Win";
                    transactionDescription = `Won bet on Tie (Dragon: ${dragonCard}, Tiger: ${tigerCard})`;
                }
                
                if (win) {
                    userPoints += winAmount;
                    resultEl.innerText = `You won! +${winAmount} points`;
                    resultEl.className = "win";
                } else {
                    userPoints -= currentBet.amount;
                    resultEl.innerText = `You lost! -${currentBet.amount} points`;
                    resultEl.className = "lose";
                }
                
                // Update points in Firestore
                updateUserPoints(currentUser.uid, userPoints);
                
                // Add transaction to Firestore
                addTransaction(
                    transactionType,
                    transactionDescription,
                    win ? winAmount : -currentBet.amount
                );
                
                pointsEl.innerText = userPoints;
                betAmountInput.max = userPoints;
                
                startNewRound();
            }, 1000);
        }

        // Update user points in Firestore
        function updateUserPoints(uid, points) {
            db.collection("users").doc(uid).update({
                points: points
            }).catch(error => {
                console.error("Error updating points:", error);
            });
        }

        // Add transaction to Firestore
        function addTransaction(type, description, amount) {
            db.collection("users").doc(currentUser.uid).collection("transactions").add({
                type: type,
                description: description,
                amount: amount,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            }).catch(error => {
                console.error("Error adding transaction:", error);
            });
        }

        // Start a new round
        function startNewRound() {
            setTimeout(() => {
                const dragonCardEl = document.getElementById("dragonCard");
                const tigerCardEl = document.getElementById("tigerCard");
                
                dragonCardEl.classList.remove("flipped", "dealing");
                tigerCardEl.classList.remove("flipped", "dealing");
                
                setTimeout(() => {
                    document.getElementById("dragonValue").innerText = "";
                    document.getElementById("tigerValue").innerText = "";
                    betAmountInput.value = 1;
                    startTimer();
                }, 500);
            }, 3000);
        }

        // Toggle statement visibility
        function toggleStatement() {
            const statementContainer = document.getElementById("statementContainer");
            const statementBtn = document.querySelector(".statement-btn");
            
            if (statementContainer.classList.contains("show")) {
                statementContainer.classList.remove("show");
                statementBtn.innerHTML = '<i class="fas fa-file-alt"></i> View Statement';
            } else {
                loadStatementData();
                statementContainer.classList.add("show");
                statementBtn.innerHTML = '<i class="fas fa-file-alt"></i> Hide Statement';
            }
        }

        // Load statement data from Firestore
        function loadStatementData() {
            const statementBody = document.getElementById("statementBody");
            statementBody.innerHTML = "<tr><td colspan='4'>Loading statement...</td></tr>";

            db.collection("users").doc(currentUser.uid).collection("transactions")
                .orderBy("timestamp", "desc")
                .limit(20)
                .get()
                .then(snapshot => {
                    statementBody.innerHTML = "";
                    
                    if (snapshot.empty) {
                        statementBody.innerHTML = "<tr><td colspan='4'>No transactions found</td></tr>";
                        return;
                    }

                    snapshot.forEach(doc => {
                        const data = doc.data();
                        const date = data.timestamp.toDate().toLocaleString();
                        const amountClass = data.amount >= 0 ? "credit" : "debit";
                        const amountText = data.amount >= 0 ? `+${data.amount}` : `${data.amount}`;
                        
                        statementBody.innerHTML += `
                            <tr>
                                <td>${date}</td>
                                <td>${data.type}</td>
                                <td>${data.description}</td>
                                <td class="${amountClass}">${amountText}</td>
                            </tr>
                        `;
                    });
                })
                .catch(error => {
                    console.error("Error loading statement:", error);
                    statementBody.innerHTML = "<tr><td colspan='4'>Error loading data</td></tr>";
                });
        }

        // Logout function
        function logout() {
            auth.signOut().then(() => {
                window.location.href = "index.html";
            }).catch(error => {
                console.error("Logout error:", error);
            });
        }
    </script>
</body>
</html>