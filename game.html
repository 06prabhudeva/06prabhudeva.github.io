<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dragon Tiger Game</title>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-firestore.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Existing styles remain the same */
        
        /* New styles */
        .round-info {
            display: flex;
            justify-content: space-between;
            background: rgba(255, 255, 255, 0.1);
            padding: 15px 20px;
            border-radius: 50px;
            margin-bottom: 20px;
            font-size: 1.2rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .round-number, .timer {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        #roundNumber, #timer {
            font-weight: bold;
            color: #ffd700;
        }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
        }
        
        .modal-content {
            background: linear-gradient(135deg, #0f2027, #203a43);
            margin: 5% auto;
            padding: 25px;
            border-radius: 15px;
            width: 90%;
            max-width: 800px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
        }
        
        .close {
            position: absolute;
            right: 25px;
            top: 15px;
            font-size: 35px;
            cursor: pointer;
            color: #aaa;
        }
        
        .close:hover {
            color: white;
        }
        
        .modal-content table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .modal-content th {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            text-align: left;
        }
        
        .modal-content td {
            padding: 12px 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .modal-content tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        
        .dragon-win {
            color: #ff416c;
        }
        
        .tiger-win {
            color: #38ef7d;
        }
        
        .tie-win {
            color: #da98b4;
        }
        
        @media (max-width: 768px) {
            .round-info {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="game-container">
            <div class="header">
                <div class="logo">
                    <i class="fas fa-dragon"></i>
                    <span>DRAGON TIGER</span>
                    <i class="fas fa-paw"></i>
                </div>
                <h1>The Ultimate Card Battle</h1>
                <p>Place your bet and see who wins!</p>
            </div>
            
            <!-- Round Info and Timer -->
            <div class="round-info">
                <div class="round-number">
                    <i class="fas fa-flag"></i>
                    Round: <span id="roundNumber">-</span>
                </div>
                <div class="timer">
                    <i class="fas fa-clock"></i>
                    Time Left: <span id="timer">-</span>
                </div>
            </div>
            
            <div class="cards">
                <div class="card-area">
                    <h2 class="dragon-title">DRAGON</h2>
                    <div id="dragonCard" class="card">
                        <div class="card-front">üêâ</div>
                        <div class="card-back">?</div>
                    </div>
                    <div id="dragonValue" class="card-value dragon-value"></div>
                </div>
                
                <div class="card-area">
                    <h2 class="tiger-title">TIGER</h2>
                    <div id="tigerCard" class="card">
                        <div class="card-front">üêÖ</div>
                        <div class="card-back">?</div>
                    </div>
                    <div id="tigerValue" class="card-value tiger-value"></div>
                </div>
            </div>
            
            <div id="result">Place your bet to start the game!</div>
            
            <div class="bet-options">
                <button id="dragonBtn" class="bet-btn" onclick="bet('dragon')">
                    <i class="fas fa-dragon"></i> Bet on Dragon
                </button>
                <button id="tieBtn" class="bet-btn" onclick="bet('tie')">
                    <i class="fas fa-handshake"></i> Bet on Tie
                </button>
                <button id="tigerBtn" class="bet-btn" onclick="bet('tiger')">
                    <i class="fas fa-paw"></i> Bet on Tiger
                </button>
                <button id="historyBtn" class="bet-btn" onclick="showHistory()" style="background:linear-gradient(to right, #8e2de2, #4a00e0)">
                    <i class="fas fa-history"></i> View History
                </button>
            </div>
            
            <div class="points-container">
                <i class="fas fa-coins"></i>
                <span>Your Points:</span>
                <span id="points">0</span>
            </div>
            
            <div class="user-panel">
                <div class="user-info">
                    <div class="user-icon">
                        <i class="fas fa-user"></i>
                    </div>
                    <div id="userEmail">user@example.com</div>
                </div>
                <button class="logout-btn" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </div>
        
        <div class="rules-panel">
            <h2><i class="fas fa-book"></i> Game Rules</h2>
            <ul class="rules-list">
                <li>
                    <span class="rule-icon"><i class="fas fa-dragon"></i></span>
                    <span>Bet on <strong>Dragon</strong> if you think Dragon card will be higher</span>
                </li>
                <li>
                    <span class="rule-icon"><i class="fas fa-paw"></i></span>
                    <span>Bet on <strong>Tiger</strong> if you think Tiger card will be higher</span>
                </li>
                <li>
                    <span class="rule-icon"><i class="fas fa-handshake"></i></span>
                    <span>Bet on <strong>Tie</strong> if you think both cards will be equal</span>
                </li>
                <li>
                    <span class="rule-icon"><i class="fas fa-coins"></i></span>
                    <span>Each bet costs <span class="chip">50</span> points</span>
                </li>
                <li>
                    <span class="rule-icon"><i class="fas fa-trophy"></i></span>
                    <span>Win <span class="chip">100</span> points for correct bet</span>
                </li>
                <li>
                    <span class="rule-icon"><i class="fas fa-clock"></i></span>
                    <span>Betting time: <span class="chip">20</span> seconds per round</span>
                </li>
                <li>
                    <span class="rule-icon"><i class="fas fa-exclamation-triangle"></i></span>
                    <span>Blocked accounts cannot play</span>
                </li>
            </ul>
        </div>
    </div>

    <!-- History Modal -->
    <div id="historyModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeHistory()">&times;</span>
            <h2><i class="fas fa-history"></i> Round History</h2>
            <table>
                <thead>
                    <tr>
                        <th>Round</th>
                        <th>Dragon</th>
                        <th>Tiger</th>
                        <th>Result</th>
                    </tr>
                </thead>
                <tbody id="historyList">
                    <tr>
                        <td colspan="4">Loading history...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyBO7dxMxJwcSEceULVYH0K6n8d59wALw7U",
            authDomain: "dragon-tiger-game-8b5b0.firebaseapp.com",
            projectId: "dragon-tiger-game-8b5b0",
            storageBucket: "dragon-tiger-game-8b5b0.firebasestorage.app",
            messagingSenderId: "885603497015",
            appId: "1:885603497015:web:afc57007437a3166ecfbb2"
        };
        
        // Initialize Firebase
        try {
            firebase.initializeApp(firebaseConfig);
        } catch (e) {
            console.error("Firebase init error:", e);
        }
        
        const db = firebase.firestore();
        let currentUser = null;
        let userPoints = 0;
        let countdown;
        let timerInterval;
        let currentRoundNumber = 0;

        // Auth state handler
        firebase.auth().onAuthStateChanged(user => {
            if (user) {
                // Check if user is blocked
                db.collection("users").doc(user.uid).get()
                    .then(doc => {
                        if (doc.exists) {
                            const userData = doc.data();
                            
                            if (userData.isBlocked) {
                                firebase.auth().signOut();
                                alert("Your account is blocked! Please contact support.");
                                window.location.href = "index.html";
                                return;
                            }
                            
                            currentUser = user;
                            document.getElementById("userEmail").innerText = user.email;
                            userPoints = userData.points || 1000;
                            document.getElementById("points").innerText = userPoints;
                            
                            // Listen for game state changes
                            db.collection("gameState").doc("currentRound").onSnapshot(doc => {
                                if (doc.exists) {
                                    const data = doc.data();
                                    currentRoundNumber = data.roundNumber;
                                    document.getElementById("roundNumber").textContent = currentRoundNumber;
                                    
                                    if (data.status === "betting") {
                                        startTimer();
                                        enableBetting(true);
                                    } else {
                                        enableBetting(false);
                                        document.getElementById("timer").textContent = "Result Phase";
                                    }
                                }
                            });
                        } else {
                            db.collection("users").doc(user.uid).set({
                                points: 1000,
                                email: user.email,
                                isBlocked: false
                            }).then(() => {
                                currentUser = user;
                                document.getElementById("userEmail").innerText = user.email;
                                userPoints = 1000;
                                document.getElementById("points").innerText = userPoints;
                            });
                        }
                    })
                    .catch(error => {
                        console.error("Error loading user data:", error);
                        document.getElementById("result").innerText = "Error loading user data";
                        document.getElementById("result").className = "lose";
                    });
            } else {
                window.location.href = "index.html";
            }
        });

        // Start timer function
        function startTimer() {
            clearInterval(timerInterval);
            countdown = 20;
            
            timerInterval = setInterval(() => {
                document.getElementById("timer").textContent = countdown + "s";
                countdown--;
                
                if (countdown < 0) {
                    clearInterval(timerInterval);
                    document.getElementById("timer").textContent = "Result Phase";
                    enableBetting(false);
                }
            }, 1000);
        }

        // Enable/disable betting
        function enableBetting(enabled) {
            document.getElementById("dragonBtn").disabled = !enabled;
            document.getElementById("tieBtn").disabled = !enabled;
            document.getElementById("tigerBtn").disabled = !enabled;
        }

        // Show history modal
        function showHistory() {
            document.getElementById("historyModal").style.display = "block";
            loadHistory();
        }

        function closeHistory() {
            document.getElementById("historyModal").style.display = "none";
        }

        // Load game history
        function loadHistory() {
            const historyList = document.getElementById("historyList");
            historyList.innerHTML = "<tr><td colspan='4'>Loading history...</td></tr>";
            
            db.collection("roundHistory")
              .orderBy("timestamp", "desc")
              .limit(50)
              .get()
              .then(snapshot => {
                  historyList.innerHTML = "";
                  
                  snapshot.forEach(doc => {
                      const data = doc.data();
                      let resultClass = "";
                      if (data.result === "dragon") resultClass = "dragon-win";
                      if (data.result === "tiger") resultClass = "tiger-win";
                      if (data.result === "tie") resultClass = "tie-win";
                      
                      historyList.innerHTML += `
                          <tr>
                              <td>${data.roundNumber}</td>
                              <td>${data.dragonCard}</td>
                              <td>${data.tigerCard}</td>
                              <td class="${resultClass}">${data.result.toUpperCase()}</td>
                          </tr>
                      `;
                  });
              });
        }

        // Betting function
        function bet(choice) {
            if (!currentUser) return;
            
            const pointsEl = document.getElementById("points");
            const resultEl = document.getElementById("result");
            
            if (userPoints < 50) {
                resultEl.innerText = "Not enough points to bet! Minimum 50 required.";
                resultEl.className = "lose";
                return;
            }
            
            // Disable buttons during processing
            const dragonBtn = document.getElementById("dragonBtn");
            const tigerBtn = document.getElementById("tigerBtn");
            const tieBtn = document.getElementById("tieBtn");
            
            dragonBtn.disabled = true;
            tigerBtn.disabled = true;
            tieBtn.disabled = true;
            
            // Get admin result if set
            db.collection("gameState").doc("currentRound").get()
                .then(doc => {
                    let dragon, tiger;
                    const adminResult = doc.data().adminResult;
                    
                    if (adminResult) {
                        // Admin has set the result
                        switch(adminResult) {
                            case "dragon":
                                dragon = 13;
                                tiger = 1;
                                break;
                            case "tiger":
                                dragon = 1;
                                tiger = 13;
                                break;
                            case "tie":
                                dragon = 10;
                                tiger = 10;
                                break;
                        }
                    } else {
                        // Random cards
                        dragon = Math.floor(Math.random() * 13) + 1;
                        tiger = Math.floor(Math.random() * 13) + 1;
                    }
                    
                    // Flip cards animation
                    const dragonCard = document.getElementById("dragonCard");
                    const tigerCard = document.getElementById("tigerCard");
                    
                    dragonCard.classList.add("flipped");
                    tigerCard.classList.add("flipped");
                    
                    // Update card values
                    setTimeout(() => {
                        document.getElementById("dragonValue").innerText = dragon;
                        document.getElementById("tigerValue").innerText = tiger;
                        
                        // Determine result
                        let result;
                        if (dragon > tiger) result = "dragon";
                        else if (tiger > dragon) result = "tiger";
                        else result = "tie";
                        
                        // Check win/loss
                        let win = (choice === result);
                        
                        // Update points
                        if (win) {
                            userPoints += 100;
                            resultEl.innerText = `You won! +100 points`;
                            resultEl.className = "win";
                        } else {
                            userPoints -= 50;
                            resultEl.innerText = `You lost! -50 points`;
                            resultEl.className = "lose";
                        }
                        
                        pointsEl.innerText = userPoints;
                        
                        // Save to Firestore
                        db.collection("users").doc(currentUser.uid).update({ 
                            points: userPoints 
                        }).catch(error => {
                            console.error("Error saving points:", error);
                        });
                        
                        // Save to history
                        db.collection("roundHistory").add({
                            roundNumber: currentRoundNumber,
                            dragonCard: dragon,
                            tigerCard: tiger,
                            result: result,
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        
                        // Re-enable buttons after delay
                        setTimeout(() => {
                            dragonBtn.disabled = false;
                            tigerBtn.disabled = false;
                            tieBtn.disabled = false;
                            
                            // Reset card animation
                            dragonCard.classList.remove("flipped");
                            tigerCard.classList.remove("flipped");
                            
                            // Clear card values for next round
                            setTimeout(() => {
                                document.getElementById("dragonValue").innerText = "";
                                document.getElementById("tigerValue").innerText = "";
                                resultEl.innerText = "Place your next bet!";
                                resultEl.className = "";
                            }, 500);
                        }, 3000);
                    }, 1000);
                });
        }
        
        // Logout function
        function logout() {
            firebase.auth().signOut().then(() => {
                window.location.href = "index.html";
            });
        }
    </script>
</body>
</html>