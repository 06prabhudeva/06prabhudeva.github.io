<!DOCTYPE html>
<html>
<head>
    <title>Dragon Tiger Game</title>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-firestore.js"></script>
    <style>
        /* ... (existing styles remain the same) ... */
        
        /* New styles for timers and bet controls */
        .timer-container {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin: 20px 0;
        }
        
        .timer {
            font-size: 24px;
            font-weight: bold;
            padding: 10px 20px;
            border-radius: 50px;
            background: rgba(0, 0, 0, 0.5);
        }
        
        #betTimer {
            color: #3498db;
        }
        
        #resultTimer {
            color: #e74c3c;
        }
        
        .bet-controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 20px 0;
        }
        
        .bet-amount {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        #betAmount {
            padding: 12px;
            width: 120px;
            font-size: 18px;
            text-align: center;
            border: 2px solid #3498db;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }
        
        .history-container {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 20px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
        }
        
        .history-item {
            padding: 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 14px;
        }
        
        .history-win {
            color: #2ecc71;
        }
        
        .history-loss {
            color: #e74c3c;
        }
        
        .blocked-message {
            background: rgba(231, 76, 60, 0.3);
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <h1>游낼 Dragon vs Tiger 游낸</h1>
        
        <div class="timer-container">
            <div class="timer">
                Bet Time: <span id="betTimer">30</span>s
            </div>
            <div class="timer">
                Result Time: <span id="resultTimer">5</span>s
            </div>
        </div>
        
        <div class="cards">
            <div>
                <div id="dragonCard" class="card">游낼</div>
                <div id="dragonValue" class="card-value dragon"></div>
            </div>
            <div>
                <div id="tigerCard" class="card">游낸</div>
                <div id="tigerValue" class="card-value tiger"></div>
            </div>
        </div>
        
        <div id="result">Place your bet!</div>
        
        <div id="blockedMessage" class="blocked-message" style="display: none;">
            Your account has been blocked. Please contact support.
        </div>
        
        <div class="bet-controls">
            <div class="bet-amount">
                <label for="betAmount">Bet Amount:</label>
                <input type="number" id="betAmount" min="1" value="50">
            </div>
            
            <div class="bet-options">
                <button id="dragonBtn" onclick="placeBet('dragon')">Bet on Dragon</button>
                <button id="tieBtn" onclick="placeBet('tie')">Bet on Tie</button>
                <button id="tigerBtn" onclick="placeBet('tiger')">Bet on Tiger</button>
            </div>
        </div>
        
        <div class="points-container">
            Your Points: <span id="points">0</span>
        </div>
        
        <div class="history-container" id="betHistory">
            <div class="history-item">Your bet history will appear here</div>
        </div>
    </div>

    <script>
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyBO7dxMxJwcSEceULVYH0K6n8d59wALw7U",
            authDomain: "dragon-tiger-game-8b5b0.firebaseapp.com",
            projectId: "dragon-tiger-game-8b5b0",
            storageBucket: "dragon-tiger-game-8b5b0.firebasestorage.app",
            messagingSenderId: "885603497015",
            appId: "1:885603497015:web:afc57007437a3166ecfbb2"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        let currentUser = null;
        let userPoints = 0;
        let userBlocked = false;
        let betTimer, resultTimer;
        let betTime = 30;
        let resultTime = 5;
        let gameActive = false;
        let currentBet = null;

        // Load user data and start game
        firebase.auth().onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                db.collection("users").doc(user.uid).onSnapshot(doc => {
                    if (doc.exists) {
                        const userData = doc.data();
                        userPoints = userData.points || 0;
                        userBlocked = userData.isBlocked || false;
                        
                        document.getElementById("points").innerText = userPoints;
                        
                        // Show/hide blocked message
                        if (userBlocked) {
                            document.getElementById("blockedMessage").style.display = "block";
                            disableGame();
                        } else {
                            document.getElementById("blockedMessage").style.display = "none";
                            if (!gameActive) startGame();
                        }
                    }
                });
                
                // Load bet history
                loadUserBetHistory();
            } else {
                window.location.href = "index.html";
            }
        });

        // Start the game round
        function startGame() {
            gameActive = true;
            resetGame();
            startBetTimer();
        }

        // Reset game state
        function resetGame() {
            document.getElementById("dragonValue").innerText = "";
            document.getElementById("tigerValue").innerText = "";
            document.getElementById("result").innerText = "Place your bet!";
            document.getElementById("result").className = "";
            currentBet = null;
            
            // Enable buttons
            document.getElementById("dragonBtn").disabled = false;
            document.getElementById("tigerBtn").disabled = false;
            document.getElementById("tieBtn").disabled = false;
            
            // Reset timers
            betTime = 30;
            resultTime = 5;
            document.getElementById("betTimer").innerText = betTime;
            document.getElementById("resultTimer").innerText = resultTime;
        }

        // Start the betting timer
        function startBetTimer() {
            clearInterval(betTimer);
            betTimer = setInterval(() => {
                betTime--;
                document.getElementById("betTimer").innerText = betTime;
                
                if (betTime <= 0) {
                    clearInterval(betTimer);
                    endBettingPhase();
                }
            }, 1000);
        }

        // End betting phase
        function endBettingPhase() {
            // Disable buttons
            document.getElementById("dragonBtn").disabled = true;
            document.getElementById("tigerBtn").disabled = true;
            document.getElementById("tieBtn").disabled = true;
            
            // Process any placed bet
            if (currentBet) {
                processBet();
            } else {
                document.getElementById("result").innerText = "No bet placed!";
                startResultTimer();
            }
        }

        // Process the bet
        function processBet() {
            // Generate random cards
            const dragon = Math.floor(Math.random() * 13) + 1;
            const tiger = Math.floor(Math.random() * 13) + 1;
            
            // Display card values
            document.getElementById("dragonValue").innerText = dragon;
            document.getElementById("tigerValue").innerText = tiger;
            
            // Check for win/loss
            let win = false;
            if (currentBet.choice === 'dragon' && dragon > tiger) win = true;
            if (currentBet.choice === 'tiger' && tiger > dragon) win = true;
            if (currentBet.choice === 'tie' && dragon === tiger) win = true;
            
            // Calculate points change
            const pointsChange = win ? currentBet.amount * 2 : -currentBet.amount;
            userPoints += pointsChange;
            
            // Update UI
            document.getElementById("points").innerText = userPoints;
            
            if (win) {
                document.getElementById("result").innerText = `You won ${currentBet.amount * 2} points!`;
                document.getElementById("result").className = "win";
            } else {
                document.getElementById("result").innerText = `You lost ${currentBet.amount} points!`;
                document.getElementById("result").className = "lose";
            }
            
            // Save to Firestore
            db.collection("users").doc(currentUser.uid).update({ 
                points: userPoints 
            });
            
            // Save bet history
            saveBetHistory(win, pointsChange);
            
            // Start result timer
            startResultTimer();
        }

        // Start result timer
        function startResultTimer() {
            clearInterval(resultTimer);
            resultTimer = setInterval(() => {
                resultTime--;
                document.getElementById("resultTimer").innerText = resultTime;
                
                if (resultTime <= 0) {
                    clearInterval(resultTimer);
                    startGame(); // Start new round
                }
            }, 1000);
        }

        // Place a bet
        function placeBet(choice) {
            if (userBlocked) {
                document.getElementById("result").innerText = "Your account is blocked!";
                return;
            }
            
            // Get bet amount
            const betAmount = parseInt(document.getElementById("betAmount").value);
            
            // Validate bet amount
            if (isNaN(betAmount) || betAmount < 1) {
                document.getElementById("result").innerText = "Minimum bet is 1 point!";
                document.getElementById("result").className = "lose";
                return;
            }
            
            if (betAmount > userPoints) {
                document.getElementById("result").innerText = "Not enough points!";
                document.getElementById("result").className = "lose";
                return;
            }
            
            // Set current bet
            currentBet = {
                choice: choice,
                amount: betAmount,
                timestamp: new Date()
            };
            
            document.getElementById("result").innerText = `Bet placed: ${betAmount} on ${choice}`;
            document.getElementById("result").className = "";
        }

        // Disable game when user is blocked
        function disableGame() {
            gameActive = false;
            clearInterval(betTimer);
            clearInterval(resultTimer);
            document.getElementById("dragonBtn").disabled = true;
            document.getElementById("tigerBtn").disabled = true;
            document.getElementById("tieBtn").disabled = true;
        }

        // Save bet history
        function saveBetHistory(win, pointsChange) {
            if (!currentUser || !currentBet) return;
            
            db.collection("bets").add({
                userId: currentUser.uid,
                userEmail: currentUser.email,
                choice: currentBet.choice,
                amount: currentBet.amount,
                win: win,
                pointsChange: pointsChange,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            })
            .then(() => {
                loadUserBetHistory(); // Refresh history display
            })
            .catch(error => {
                console.error("Error saving bet history:", error);
            });
        }

        // Load user bet history
        function loadUserBetHistory() {
            if (!currentUser) return;
            
            const betHistoryEl = document.getElementById("betHistory");
            betHistoryEl.innerHTML = "<div class='history-item'>Loading history...</div>";
            
            db.collection("bets")
                .where("userId", "==", currentUser.uid)
                .orderBy("timestamp", "desc")
                .limit(10)
                .get()
                .then(querySnapshot => {
                    betHistoryEl.innerHTML = "";
                    
                    if (querySnapshot.empty) {
                        betHistoryEl.innerHTML = "<div class='history-item'>No bet history found</div>";
                        return;
                    }
                    
                    querySnapshot.forEach(doc => {
                        const bet = doc.data();
                        const time = bet.timestamp ? bet.timestamp.toDate().toLocaleTimeString() : "N/A";
                        const resultClass = bet.win ? "history-win" : "history-loss";
                        const resultText = bet.win ? "Won" : "Lost";
                        const pointsChange = bet.win ? `+${bet.pointsChange}` : bet.pointsChange;
                        
                        betHistoryEl.innerHTML += `
                            <div class="history-item ${resultClass}">
                                [${time}] ${resultText} ${Math.abs(pointsChange)} points on ${bet.choice}
                            </div>
                        `;
                    });
                })
                .catch(error => {
                    console.error("Error loading bet history:", error);
                    betHistoryEl.innerHTML = "<div class='history-item'>Error loading history</div>";
                });
        }
    </script>
</body>
</html>
